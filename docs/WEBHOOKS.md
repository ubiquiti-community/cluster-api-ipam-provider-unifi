# Webhook Implementation Summary

## Overview
Comprehensive validation and defaulting webhooks have been implemented for `UnifiIPPool` and `UnifiInstance` resources, following the Cluster API IPAM provider reference patterns.

## Files Created/Modified

### Webhook Implementations

#### 1. `internal/webhooks/unifiippool_webhook.go` (317 lines)
**Purpose:** Validation and defaulting webhook for UnifiIPPool resources

**Validation Rules:**
- **Create/Update Validation:**
  - CIDR format must match prefix field (`cidr.Bits() == subnet.Prefix`)
  - Gateway IP must be within CIDR range
  - ExcludeRanges must be within subnet (supports both CIDR and IP formats)
  - DNS server IPs are valid addresses
  - UnifiInstance reference exists (Client.Get lookup)
  - NetworkID is not empty
  - At least one subnet is required

- **Update Protection:**
  - Prevents orphaning allocated IPs by comparing old/new pool IPSets
  - Builds IPSet from subnet CIDRs and exclude ranges
  - Rejects updates that would exclude currently allocated IPs

- **Delete Protection:**
  - Lists all IPAddress resources with matching PoolRef
  - Blocks deletion if any IPAddresses are allocated
  - Bypass with annotation: `ipam.cluster.x-k8s.io/skip-validate-delete-webhook`

**Defaulting:**
- Sets `InstanceRef.Namespace` to pool namespace if empty

**Kubebuilder Markers:**
```go
// +kubebuilder:webhook:path=/mutate-ipam-cluster-x-k8s-io-v1alpha1-unifiippool
// +kubebuilder:webhook:path=/validate-ipam-cluster-x-k8s-io-v1alpha1-unifiippool
```

#### 2. `internal/webhooks/unifiinstance_webhook.go` (237 lines)
**Purpose:** Validation and defaulting webhook for UnifiInstance resources

**Validation Rules:**
- **Create/Update Validation:**
  - Host URL format: `url.Parse` validation
  - Scheme must be http or https
  - Host must not be empty
  - CredentialsRef secret exists (Client.Get lookup)
  - Secret contains `apiKey` field in Data
  - Site name format: alphanumeric, dash, underscore only

- **Delete Protection:**
  - Lists all UnifiIPPool resources in namespace
  - Checks if any pool references this instance
  - Blocks deletion if references exist

**Defaulting:**
- Sets `site` to "default" if empty

**Kubebuilder Markers:**
```go
// +kubebuilder:webhook:path=/mutate-ipam-cluster-x-k8s-io-v1alpha1-unifiinstance
// +kubebuilder:webhook:path=/validate-ipam-cluster-x-k8s-io-v1alpha1-unifiinstance
```

### Main Controller Integration

#### 3. `cmd/manager/main.go`
**Changes:**
- Added imports:
  - `"github.com/ubiquiti-community/cluster-api-ipam-provider-unifi/internal/webhooks"`
  - `"sigs.k8s.io/controller-runtime/pkg/webhook"`
  
- Added webhook flags:
  ```go
  webhookPort    int    // default: 9443
  webhookCertDir string // default: /tmp/k8s-webhook-server/serving-certs
  ```

- Configured webhook server in manager options:
  ```go
  WebhookServer: webhook.NewServer(webhook.Options{
      Port:    webhookPort,
      CertDir: webhookCertDir,
  })
  ```

- Registered webhooks after controllers:
  ```go
  if err = (&webhooks.UnifiIPPoolWebhook{}).SetupWebhookWithManager(mgr); err != nil {
      setupLog.Error(err, "unable to create webhook", "webhook", "UnifiIPPool")
      os.Exit(1)
  }
  if err = (&webhooks.UnifiInstanceWebhook{}).SetupWebhookWithManager(mgr); err != nil {
      setupLog.Error(err, "unable to create webhook", "webhook", "UnifiInstance")
      os.Exit(1)
  }
  ```

### Webhook Configuration Structure

#### 4. `config/webhook/`
- **`manifests.yaml`** (generated by controller-gen):
  - `MutatingWebhookConfiguration` with 2 webhooks:
    - `munifiinstance.kb.io` - CREATE, UPDATE operations
    - `munifiippool.kb.io` - CREATE, UPDATE operations
  - `ValidatingWebhookConfiguration` with 2 webhooks:
    - `vunifiinstance.kb.io` - CREATE, UPDATE, DELETE operations
    - `vunifiippool.kb.io` - CREATE, UPDATE, DELETE operations
  - Service name: `webhook-service`
  - Namespace: `system` (replaced by kustomize)
  - Paths: `/mutate-*` and `/validate-*`

- **`service.yaml`**:
  - Webhook service listening on port 443 → targetPort 9443
  - Selector: `control-plane: controller-manager`

- **`kustomization.yaml`**:
  - Resources: manifests.yaml, service.yaml
  - Configurations: kustomizeconfig.yaml

- **`kustomizeconfig.yaml`**:
  - NameReference transformers for service name substitution
  - Namespace transformers for webhook clientConfig

#### 5. `config/crd/patches/`
Created webhook patches for CRDs:

- **`webhook_in_unifiinstances.yaml`**:
  - Enables conversion webhook for UnifiInstance CRD
  - Path: `/convert`

- **`webhook_in_unifiippools.yaml`**:
  - Enables conversion webhook for UnifiIPPool CRD
  - Path: `/convert`

- **`cainjection_in_unifiinstances.yaml`**:
  - Adds cert-manager annotation for CA injection

- **`cainjection_in_unifiippools.yaml`**:
  - Adds cert-manager annotation for CA injection

#### 6. `config/default/`
Updated kustomization and created patches:

- **`kustomization.yaml`** (rewritten):
  - Added resources: `../webhook`
  - Added patches: `manager_webhook_patch.yaml`, `webhookcainjection_patch.yaml`, `manager_auth_proxy_patch.yaml`
  - Added replacements for webhook service name/namespace substitution
  - Uses `kustomize.config.k8s.io/v1beta1`

- **`manager_webhook_patch.yaml`** (created):
  - Adds webhook server port 9443 to manager container
  - Mounts certificate volume from secret `webhook-server-cert`

- **`webhookcainjection_patch.yaml`** (created):
  - Adds cert-manager annotations to webhook configurations
  - References: `$(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)`

- **`manager_auth_proxy_patch.yaml`** (created):
  - Adds kube-rbac-proxy sidecar for metrics endpoint protection
  - Image: `gcr.io/kubebuilder/kube-rbac-proxy:v0.15.0`
  - Listens on 8443, proxies to manager's 8080

#### 7. `config/rbac/`
Created complete RBAC structure:

- **`kustomization.yaml`** (created)
- **`service_account.yaml`** (created): `controller-manager`
- **`role_binding.yaml`** (created): Binds `manager-role` to service account
- **`leader_election_role.yaml`** (created): ConfigMaps, Leases, Events
- **`leader_election_role_binding.yaml`** (created): Binds leader election role

#### 8. `config/crd/kustomization.yaml`
Updated with webhook patches:
```yaml
patches:
- path: patches/webhook_in_unifiinstances.yaml
- path: patches/webhook_in_unifiippools.yaml
- path: patches/cainjection_in_unifiinstances.yaml
- path: patches/cainjection_in_unifiippools.yaml
```

## Validation Features

### UnifiIPPool Validation
1. **CIDR Validation**: Ensures CIDR string matches prefix length
2. **Gateway Validation**: Gateway IP must be within CIDR range
3. **Exclude Ranges**: Validates IPs/CIDRs are within subnet
4. **DNS Validation**: DNS server IPs must be valid addresses
5. **Reference Validation**: UnifiInstance must exist
6. **NetworkID Check**: Must not be empty
7. **Subnet Count**: At least one subnet required
8. **Update Safety**: Prevents orphaning allocated IPs using IPSet comparison
9. **Delete Safety**: Blocks deletion if IPAddresses allocated (bypass annotation supported)

### UnifiInstance Validation
1. **URL Format**: Valid HTTP/HTTPS URL with host
2. **Credentials**: Secret must exist and contain `apiKey` field
3. **Site Name**: Alphanumeric characters, dash, underscore only
4. **Delete Safety**: Blocks deletion if UnifiIPPools reference the instance

## Defaulting Features

### UnifiIPPool
- Sets `InstanceRef.Namespace` to pool namespace if empty

### UnifiInstance
- Sets `site` to "default" if empty

## Deployment Configuration

### Webhook Server
- **Port**: 9443 (configurable via `--webhook-port`)
- **Cert Directory**: `/tmp/k8s-webhook-server/serving-certs` (configurable via `--webhook-cert-dir`)
- **Certificate Management**: Expects cert-manager to inject CA bundle and create secret `webhook-server-cert`

### Webhook Endpoints
- **Mutating**: `/mutate-ipam-cluster-x-k8s-io-v1alpha1-{resource}`
- **Validating**: `/validate-ipam-cluster-x-k8s-io-v1alpha1-{resource}`
- **Conversion**: `/convert` (for future CRD version changes)

### Service Configuration
- **Service Name**: `unifi-ipam-webhook-service` (after namePrefix)
- **Namespace**: `ipam-system`
- **Port**: 443 → 9443
- **Selector**: `control-plane: controller-manager`

## Build Verification

All build targets pass:
```bash
✓ make manifests  # Generates CRDs, RBAC, webhook configs
✓ make build      # Compiles manager binary
✓ kubectl kustomize config/default  # Generates full deployment YAML
```

## Generated Webhook Configurations

The `make manifests` command generates:
- **2 Mutating Webhooks**: CREATE, UPDATE operations
- **2 Validating Webhooks**: CREATE, UPDATE, DELETE operations
- **Service**: webhook-service (port 443 → 9443)
- **CRD Patches**: Conversion webhook and CA injection annotations

## Next Steps

To deploy with webhooks:

1. **Install cert-manager** (if not already installed):
   ```bash
   kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
   ```

2. **Create Certificate Issuer** (example):
   ```yaml
   apiVersion: cert-manager.io/v1
   kind: Issuer
   metadata:
     name: selfsigned-issuer
     namespace: ipam-system
   spec:
     selfSigned: {}
   ---
   apiVersion: cert-manager.io/v1
   kind: Certificate
   metadata:
     name: webhook-server-cert
     namespace: ipam-system
   spec:
     dnsNames:
     - unifi-ipam-webhook-service.ipam-system.svc
     - unifi-ipam-webhook-service.ipam-system.svc.cluster.local
     issuerRef:
       kind: Issuer
       name: selfsigned-issuer
     secretName: webhook-server-cert
   ```

3. **Update kustomization** to set certificate variables:
   ```yaml
   # config/default/kustomization.yaml
   vars:
   - name: CERTIFICATE_NAMESPACE
     objref:
       kind: Certificate
       name: webhook-server-cert
     fieldref:
       fieldpath: metadata.namespace
   - name: CERTIFICATE_NAME
     objref:
       kind: Certificate
       name: webhook-server-cert
   ```

4. **Deploy**:
   ```bash
   make deploy IMG=<your-image>
   ```

## Testing Webhooks

### Test UnifiIPPool Validation
```bash
# Valid pool
kubectl apply -f config/samples/unifiippool.yaml

# Invalid CIDR (should fail)
cat <<EOF | kubectl apply -f -
apiVersion: ipam.cluster.x-k8s.io/v1alpha1
kind: UnifiIPPool
metadata:
  name: test-pool
spec:
  instanceRef:
    name: my-unifi
  networkID: "1234567890abcdef"
  subnets:
  - cidr: 192.168.1.0/25  # Wrong prefix
    prefix: 24            # Mismatch!
    gateway: 192.168.1.1
EOF
# Expected error: "CIDR 192.168.1.0/25 does not match prefix 24"
```

### Test UnifiInstance Validation
```bash
# Invalid URL (should fail)
cat <<EOF | kubectl apply -f -
apiVersion: ipam.cluster.x-k8s.io/v1alpha1
kind: UnifiInstance
metadata:
  name: test-instance
spec:
  host: "not-a-url"  # Invalid!
  credentialsRef:
    name: unifi-creds
EOF
# Expected error: "host must be a valid URL with http or https scheme"
```

## Bypass Annotations

To force deletion despite validation errors:
```bash
kubectl annotate unifiippool my-pool ipam.cluster.x-k8s.io/skip-validate-delete-webhook=""
kubectl delete unifiippool my-pool
```

## Dependencies

The webhooks use the following libraries:
- `sigs.k8s.io/controller-runtime/pkg/webhook` - Webhook framework
- `sigs.k8s.io/controller-runtime/pkg/webhook/admission` - Admission handler
- `k8s.io/apimachinery/pkg/util/validation/field` - Field validation
- `net/netip` - IP/CIDR parsing
- `go4.org/netipx` - IPSet operations
- `net/url` - URL validation

## Conclusion

The webhook implementation provides comprehensive validation and defaulting for UnifiIPPool and UnifiInstance resources, preventing invalid configurations and protecting against accidental deletion of in-use resources. The implementation follows Cluster API patterns and Kubebuilder best practices for admission webhooks.
